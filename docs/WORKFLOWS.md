# تدفقات العمل (Workflows) - نظام قياس الأداء الوظيفي

## 📋 فهرس تدفقات العمل

1. [تسجيل الدخول والمصادقة](#1-تسجيل-الدخول-والمصادقة)
2. [إنشاء هدف جديد](#2-إنشاء-هدف-جديد)
3. [الموافقة على الأهداف](#3-الموافقة-على-الأهداف)
4. [تحديث تقدم الأهداف](#4-تحديث-تقدم-الأهداف)
5. [إنشاء التقييم](#5-إنشاء-التقييم)
6. [إدخال درجات التقييم](#6-إدخال-درجات-التقييم)
7. [إنهاء التقييم والحساب التلقائي](#7-إنهاء-التقييم-والحساب-التلقائي)
8. [إنشاء PIP تلقائي](#8-إنشاء-pip-تلقائي)
9. [اعتماد التقييم من HR](#9-اعتماد-التقييم-من-hr)
10. [إدارة خطط التحسين (PIPs)](#10-إدارة-خطط-التحسين-pips)
11. [إدارة التدريبات](#11-إدارة-التدريبات)
12. [توليد التقارير](#12-توليد-التقارير)
13. [نظام الإشعارات](#13-نظام-الإشعارات)

---

## 1. تسجيل الدخول والمصادقة

### المسار (Flow)
```
┌──────────────┐
│   المستخدم   │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. فتح صفحة Login           │
│    URL: /login              │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. إدخال البيانات          │
│    - Username               │
│    - Password               │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. إرسال POST Request      │
│    POST /api/auth/login     │
│    Body: {username, password}│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. Backend: التحقق          │
│    - البحث عن المستخدم     │
│    - التحقق من كلمة المرور  │
│    - PBKDF2-SHA256          │
└──────┬──────────────────────┘
       │
       ├─► [فشل التحقق] ──► رسالة خطأ "خطأ في اسم المستخدم أو كلمة المرور"
       │
       ▼ [نجح التحقق]
┌─────────────────────────────┐
│ 5. توليد JWT Token         │
│    Claims:                  │
│    - UserId                 │
│    - Username               │
│    - Roles []               │
│    - Permissions []         │
│    - Expiry: 24 hours       │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. Frontend: حفظ Token     │
│    localStorage.setItem()   │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. Redirect حسب الدور      │
│    - Employee → /employee   │
│    - Manager → /manager     │
│    - HR → /hr               │
│    - Admin → /admin         │
│    - Executive → /executive │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────┐
│ Dashboard    │
└──────────────┘
```

### الأدوار والصلاحيات
| الدور | الصفحة الافتراضية | الصلاحيات الأساسية |
|-------|-------------------|-------------------|
| Employee | /employee | عرض أهدافه، تحديث التقدم، عرض تقييماته |
| Manager | /manager | جميع صلاحيات Employee + الموافقة على أهداف الفريق + إنشاء تقييمات |
| HR | /hr | عرض الكل + إدارة PIPs + اعتماد التقييمات |
| Admin | /admin | إدارة المستخدمين + الأدوار + الأقسام |
| Executive | /executive | عرض KPIs + التقارير الاستراتيجية |

---

## 2. إنشاء هدف جديد

### المسار (Flow)
```
┌──────────────┐
│   الموظف     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. الانتقال إلى صفحة        │
│    "أهدافي" /employee/goals │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. الضغط على زر              │
│    "إنشاء هدف جديد"         │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ 3. فتح CreateGoalDialog               │
│    الحقول المطلوبة:                   │
│    ├─ العنوان (Title) *               │
│    ├─ الوصف (Description)             │
│    ├─ النوع (Type) * ────────────┐    │
│    │  ├─ استراتيجي (Strategic)   │    │
│    │  ├─ تشغيلي (Operational)    │    │
│    │  └─ تطويري (Development)    │    │
│    ├─ الفئة (Category)           │    │
│    ├─ الوزن (Weight) * ───────────┐    │
│    │  التحقق: 1 ≤ Weight ≤ 100  │    │
│    ├─ القيمة المستهدفة           │    │
│    ├─ وحدة القياس                │    │
│    ├─ تاريخ البدء (StartDate) *  │    │
│    └─ تاريخ الانتهاء (EndDate) * │    │
│       التحقق: EndDate > StartDate │    │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────┐
│ 4. التحقق من SMART          │
│    ☑ Specific (محدد)        │
│    ☑ Measurable (قابل للقياس)│
│    ☑ Achievable (قابل للتحقيق)│
│    ☑ Relevant (ذو صلة)      │
│    ☑ Time-bound (محدد بوقت) │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. إرسال POST Request      │
│    POST /api/goals          │
│    Body: {                  │
│      employeeId,            │
│      title,                 │
│      description,           │
│      type,                  │
│      weight,                │
│      startDate,             │
│      endDate,               │
│      ...                    │
│    }                        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. Backend: الحفظ          │
│    - إنشاء Goal Entity     │
│    - Status = "Draft"       │
│    - ProgressPercent = 0    │
│    - CreatedAt = Now        │
│    - Save to DB             │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. إرسال إشعار للمدير      │
│    NotificationType:        │
│      "NewGoalCreated"       │
│    Message:                 │
│      "{موظف} أنشأ هدف جديد" │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 8. Frontend: تحديث القائمة │
│    - إضافة الهدف للقائمة   │
│    - عرض رسالة نجاح        │
│    - إغلاق Dialog           │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────┐
│ الهدف في     │
│ حالة "مسودة" │
└──────────────┘
```

### قواعد الأعمال
1. **مجموع الأوزان**: يجب أن يساوي مجموع أوزان أهداف الموظف 100% في نهاية الفترة
2. **الحالة الأولية**: جميع الأهداف الجديدة تبدأ بحالة "Draft"
3. **SMART Validation**: يجب أن يتبع الهدف معايير SMART
4. **التواريخ**: تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء
5. **الوزن**: يجب أن يكون بين 1-100

---

## 3. الموافقة على الأهداف

### المسار (Flow)
```
┌──────────────┐
│   المدير     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. يستلم إشعار              │
│    "هدف جديد بحاجة للموافقة"│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. الانتقال إلى             │
│    /manager/team-goals      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. عرض قائمة الأهداف       │
│    Filter: Status = "Draft" │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. اختيار الهدف للمراجعة   │
│    - الضغط على "مراجعة     │
│      والموافقة"             │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│ 5. فتح GoalApprovalDialog              │
│    عرض:                                 │
│    ├─ تفاصيل الهدف الكاملة             │
│    ├─ معلومات الموظف                   │
│    ├─ SMART Criteria Checklist          │
│    │  ☑ Specific                        │
│    │  ☑ Measurable                      │
│    │  ☑ Achievable                      │
│    │  ☑ Relevant                        │
│    │  ☑ Time-bound                      │
│    └─ حقل ملاحظات المدير (اختياري)     │
└──────┬───────────────────────────────────┘
       │
       ├─────────────────┬──────────────────┐
       │                 │                  │
       ▼                 ▼                  ▼
   [رفض]           [موافقة]           [إلغاء]
       │                 │                  │
       ▼                 ▼                  │
┌──────────────┐  ┌─────────────────┐      │
│POST          │  │POST             │      │
│/api/goals/   │  │/api/goals/      │      │
│{id}/approve  │  │{id}/approve     │      │
│              │  │                 │      │
│Body: {       │  │Body: {          │      │
│ approved:    │  │ approved: true, │      │
│  false,      │  │ notes: "..."    │      │
│ notes: "..." │  │}                │      │
│}             │  └────┬────────────┘      │
└──────┬───────┘       │                   │
       │               │                   │
       ▼               ▼                   │
┌──────────────┐  ┌─────────────────┐      │
│Backend:      │  │Backend:         │      │
│Goal.Status   │  │Goal.Status      │      │
│= "Cancelled" │  │= "Approved"     │      │
│              │  │Goal.ApprovedAt  │      │
│إشعار        │  │= Now            │      │
│للموظف       │  │Goal.ApprovedBy  │      │
│"تم رفض      │  │= ManagerId      │      │
│ الهدف"      │  │                 │      │
└──────┬───────┘  │إشعار للموظف    │      │
       │          │"تمت الموافقة   │      │
       │          │ على الهدف"     │      │
       │          └────┬────────────┘      │
       │               │                   │
       └───────────────┴───────────────────┘
                       │
                       ▼
┌───────────────────────────────────────────┐
│ Frontend: تحديث القائمة                  │
│ - تحديث حالة الهدف                       │
│ - عرض رسالة نجاح                         │
│ - تحديث الإحصائيات                       │
└───────────────────────────────────────────┘
```

### حالات الهدف بعد الموافقة
```
Draft ──┐
        ├─► [موافقة] ──► Approved ──► InProgress ──► Completed
        │
        └─► [رفض] ──► Cancelled
```

---

## 4. تحديث تقدم الأهداف

### المسار (Flow)
```
┌──────────────┐
│   الموظف     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. عرض قائمة أهدافه        │
│    الأهداف المعتمدة فقط    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. اختيار هدف لتحديث التقدم│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. إدخال نسبة الإنجاز      │
│    Slider: 0% → 100%        │
│    إضافة ملاحظات (اختياري) │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. إرسال PUT Request       │
│    PUT /api/goals/{id}/     │
│        progress             │
│    Body: {                  │
│      progressPercent: 75,   │
│      notes: "..."           │
│    }                        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. Backend: التحديث         │
│    Goal.ProgressPercent = 75│
│    Goal.LastUpdated = Now   │
│                             │
│    If ProgressPercent = 100:│
│       Goal.Status =         │
│         "Completed"         │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. إشعار للمدير            │
│    "{موظف} حدّث تقدم        │
│     الهدف إلى {نسبة}%"     │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. Frontend: تحديث العرض   │
│    - تحديث Progress Bar     │
│    - تحديث الحالة (إن 100%)│
│    - عرض رسالة نجاح        │
└──────────────────────────────┘
```

### تغيير الحالات التلقائي
```
Approved ──► [تحديث التقدم > 0%] ──► InProgress

InProgress ──► [تحديث التقدم = 100%] ──► Completed
```

---

## 5. إنشاء التقييم

### المسار (Flow)
```
┌──────────────┐
│   المدير     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. الانتقال إلى            │
│    /manager/team-evaluations│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. الضغط على               │
│    "إنشاء تقييم جديد"       │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 3. فتح CreateEvaluationDialog     │
│    الحقول:                         │
│    ├─ اختيار الموظف *             │
│    ├─ الفترة (Period) *            │
│    │  مثال: "2024-Q4" أو "2024"   │
│    └─ نوع التقييم *                │
│       ├─ سنوي (Annual)            │
│       ├─ ربع سنوي (Quarterly)     │
│       └─ نصف سنوي (MidYear)       │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. التحقق من التكرار       │
│    - هل يوجد تقييم لنفس     │
│      الموظف والفترة؟       │
└──────┬──────────────────────┘
       │
       ├─► [موجود] ──► رسالة خطأ "يوجد تقييم لهذه الفترة"
       │
       ▼ [غير موجود]
┌─────────────────────────────┐
│ 5. إرسال POST Request      │
│    POST /api/evaluations    │
│    Body: {                  │
│      employeeId,            │
│      period,                │
│      evaluationType         │
│    }                        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. Backend: الإنشاء         │
│    - إنشاء Evaluation       │
│    - Status = "Draft"       │
│    - GoalsScore = null      │
│    - BehaviorScore = null   │
│    - InitiativesScore = null│
│    - TrainingImpact = 0     │
│    - CreatedAt = Now        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. حساب أثر التدريب        │
│    - جلب Training Records   │
│    - حساب معدل الحضور      │
│    If معدل ≥ 85%:          │
│       TrainingImpact = +0.15│
│    Else If معدل < 60%:     │
│       TrainingImpact = -0.20│
│    Else:                    │
│       TrainingImpact = 0    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 8. Frontend: التحديث       │
│    - إضافة للقائمة          │
│    - عرض رسالة نجاح        │
│    - فتح صفحة التقييم       │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────┐
│ التقييم في   │
│ حالة "مسودة" │
│ جاهز لإدخال │
│  الدرجات    │
└──────────────┘
```

---

## 6. إدخال درجات التقييم

### المسار (Flow)
```
┌──────────────┐
│   المدير     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. فتح التقييم (Draft)      │
└──────┬──────────────────────┘
       │
       ▼
┌────────────────────────────────────────────┐
│ 2. فتح EvaluationScoringDialog           │
│    الدرجات المطلوبة:                      │
│                                            │
│    A) درجة الأهداف (Goals Score)         │
│       ├─ Range: 0.0 - 5.0                │
│       ├─ الوزن في المعادلة: 60%          │
│       └─ التحقق: رقم صحيح أو عشري        │
│                                            │
│    B) درجة السلوك (Behavior Score)       │
│       ├─ Range: 0.0 - 5.0                │
│       ├─ الوزن في المعادلة: 30%          │
│       └─ تقييم الكفاءات السلوكية          │
│                                            │
│    C) درجة المبادرات (Initiatives Score) │
│       ├─ Range: 0.0 - 5.0                │
│       ├─ الوزن في المعادلة: 10%          │
│       └─ الإبداع والمساهمات الإضافية     │
│                                            │
│    D) ملاحظات المدير (Manager Notes)     │
│       └─ نص حر (اختياري)                 │
└──────┬─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. التحقق من صحة الدرجات   │
│    - كل درجة بين 0-5        │
│    - رقم صحيح أو عشري       │
│    - مطلوبة جميعاً          │
└──────┬──────────────────────┘
       │
       ├─► [فشل] ──► رسالة خطأ
       │
       ▼ [نجح]
┌─────────────────────────────┐
│ 4. إرسال PUT Request       │
│    PUT /api/evaluations/    │
│        {id}/scores          │
│    Body: {                  │
│      goalsScore: 4.5,       │
│      behaviorScore: 4.0,    │
│      initiativesScore: 3.5, │
│      managerNotes: "..."    │
│    }                        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. Backend: حفظ الدرجات    │
│    Evaluation.GoalsScore    │
│      = 4.5                  │
│    Evaluation.BehaviorScore │
│      = 4.0                  │
│    Evaluation.              │
│      InitiativesScore = 3.5 │
│    Evaluation.ManagerNotes  │
│      = "..."                │
│    Status = "InProgress"    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. Frontend: عرض المعاينة   │
│    - عرض الدرجات المدخلة   │
│    - حساب النتيجة المتوقعة  │
│      (بدون حفظها بعد)       │
│    - زر "إنهاء التقييم"     │
└──────────────────────────────┘
```

### معايير التقييم الموصى بها

#### درجة الأهداف (Goals Score)
```
5.0: أنجز 100% من الأهداف وتجاوز التوقعات
4.0: أنجز 100% من الأهداف كما هو متوقع
3.0: أنجز 75-90% من الأهداف
2.0: أنجز 50-74% من الأهداف
1.0: أنجز أقل من 50% من الأهداف
```

#### درجة السلوك (Behavior Score)
```
5.0: سلوك استثنائي، قدوة للآخرين
4.0: سلوك ممتاز، يتجاوز التوقعات
3.0: سلوك جيد، يلبي التوقعات
2.0: سلوك مقبول، يحتاج تحسين
1.0: سلوك غير مقبول
```

#### درجة المبادرات (Initiatives Score)
```
5.0: مبادرات استثنائية ذات أثر كبير
4.0: مبادرات ممتازة ومتعددة
3.0: مبادرات جيدة
2.0: بعض المبادرات
1.0: لا يوجد مبادرات
```

---

## 7. إنهاء التقييم والحساب التلقائي

### المسار (Flow)
```
┌──────────────┐
│   المدير     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. بعد إدخال جميع الدرجات  │
│    الضغط على "إنهاء التقييم"│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. التحقق من اكتمال البيانات│
│    ✓ GoalsScore موجود      │
│    ✓ BehaviorScore موجود   │
│    ✓ InitiativesScore موجود│
└──────┬──────────────────────┘
       │
       ├─► [ناقص] ──► رسالة خطأ "يجب إدخال جميع الدرجات"
       │
       ▼ [مكتمل]
┌─────────────────────────────┐
│ 3. إرسال POST Request      │
│    POST /api/evaluations/   │
│         {id}/finalize       │
│    Body: {                  │
│      managerNotes: "..."    │
│    }                        │
└──────┬──────────────────────┘
       │
       ▼
┌────────────────────────────────────────────┐
│ 4. Backend: الحساب التلقائي              │
│                                            │
│    المعادلة:                               │
│    ┌──────────────────────────────────┐   │
│    │ FinalScore =                     │   │
│    │   (GoalsScore × 0.6) +           │   │
│    │   (BehaviorScore × 0.3) +        │   │
│    │   (InitiativesScore × 0.1) +     │   │
│    │   TrainingImpact                 │   │
│    └──────────────────────────────────┘   │
│                                            │
│    مثال:                                   │
│    GoalsScore = 4.5                       │
│    BehaviorScore = 4.0                    │
│    InitiativesScore = 3.5                 │
│    TrainingImpact = +0.15 (معدل 90%)     │
│                                            │
│    الحساب:                                │
│    = (4.5 × 0.6) + (4.0 × 0.3) +         │
│      (3.5 × 0.1) + 0.15                  │
│    = 2.7 + 1.2 + 0.35 + 0.15             │
│    = 4.40                                 │
│                                            │
│    Evaluation.FinalScore = 4.40          │
└──────┬─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. تحديد التصنيف (Rating)   │
│    بناءً على النتيجة:       │
│                             │
│    If FinalScore ≥ 4.0:    │
│       Rating = "Outstanding"│
│    Else If FinalScore ≥ 3.5:│
│       Rating =              │
│         "ExceedsExpectations"│
│    Else If FinalScore ≥ 2.5:│
│       Rating =              │
│         "MeetsExpectations" │
│    Else If FinalScore ≥ 2.0:│
│       Rating =              │
│         "NeedsImprovement"  │
│    Else:                    │
│       Rating =              │
│         "Unsatisfactory"    │
│                             │
│    في المثال:               │
│    FinalScore = 4.40       │
│    Rating = "Outstanding"   │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. حفظ النتائج              │
│    Evaluation.FinalRating   │
│      = "Outstanding"        │
│    Evaluation.Status        │
│      = "Finalized"          │
│    Evaluation.EvaluatedAt   │
│      = Now                  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. التحقق من PIP            │
│    If FinalScore < 2.5:     │
│       └─► إنشاء PIP تلقائي  │
│            (انظر Workflow 8)│
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 8. إشعارات                 │
│    ├─ إشعار للموظف:        │
│    │   "تم إنهاء تقييمك"    │
│    │   (بدون عرض النتيجة)   │
│    └─ إشعار لـ HR:          │
│       "تقييم جديد بحاجة     │
│        للاعتماد"            │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────┐
│ التقييم في   │
│ حالة "Finalized"│
│ بانتظار اعتماد│
│    HR        │
└──────────────┘
```

### تدفق القرار للتصنيف
```
                  FinalScore
                      │
        ┌─────────────┼─────────────┐
        │             │             │
     ≥ 4.0         ≥ 3.5         ≥ 2.5
        │             │             │
        ▼             ▼             ▼
  Outstanding   ExceedsExpect  MeetsExpect

        │             │             │
     < 4.0         < 3.5         < 2.5
        │             │             │
        └─────────────┴─────────────┘
                      │
                   ≥ 2.0
                      │
                      ▼
               NeedsImprovement
                      │
                   < 2.0
                      │
                      ▼
               Unsatisfactory
                      │
                      └──► إنشاء PIP تلقائي
```

---

## 8. إنشاء PIP تلقائي

### المسار (Flow)
```
┌─────────────────────────────┐
│ Trigger: FinalScore < 2.5   │
│ (من Workflow 7)             │
└──────┬──────────────────────┘
       │
       ▼
┌────────────────────────────────────────────┐
│ 1. Backend: Auto Create PIP               │
│                                            │
│    بيانات الـ PIP:                         │
│    ├─ EmployeeId (من التقييم)            │
│    ├─ EvaluationId (التقييم المرتبط)     │
│    ├─ Status = "Draft"                    │
│    ├─ Reason = "Low Performance Score"   │
│    ├─ StartDate = Now                     │
│    ├─ ExpectedEndDate = Now + 3 Months   │
│    ├─ CreatedBy = ManagerId               │
│    ├─ CreatedAt = Now                     │
│    └─ Goals (أهداف تحسينية)              │
│       يتم إنشاء 3 أهداف تحسينية افتراضية:│
│       1. تحسين الأهداف الرئيسية          │
│       2. تطوير المهارات السلوكية          │
│       3. زيادة المبادرات                  │
└──────┬─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. إرسال إشعارات متعددة     │
│    A) إشعار للموظف:         │
│       "تم إنشاء خطة تحسين   │
│        أداء لك"             │
│                             │
│    B) إشعار للمدير:         │
│       "تم إنشاء PIP تلقائياً│
│        للموظف {name}"      │
│                             │
│    C) إشعار لـ HR:           │
│       "PIP جديد بحاجة       │
│        للمراجعة والمتابعة" │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. إرسال Email للموظف      │
│    الموضوع:                │
│      "خطة تحسين الأداء"    │
│    المحتوى:                │
│      - شرح السبب           │
│      - الأهداف التحسينية   │
│      - المدة الزمنية       │
│      - الدعم المتاح        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. جدولة متابعات PIP        │
│    ├─ اجتماع بعد أسبوع     │
│    ├─ اجتماع بعد شهر       │
│    ├─ اجتماع بعد شهرين     │
│    └─ تقييم نهائي بعد 3 أشهر│
└──────┬──────────────────────┘
       │
       ▼
┌──────────────┐
│ PIP نشط     │
│ Status:      │
│ "InProgress" │
└──────────────┘
```

### دورة حياة PIP
```
                  [FinalScore < 2.5]
                         │
                         ▼
┌──────────────────────────────────────┐
│         إنشاء PIP تلقائي            │
│         Status: "Draft"              │
└──────────┬───────────────────────────┘
           │
           │ [HR Review & Approve]
           ▼
┌──────────────────────────────────────┐
│         بدء خطة التحسين              │
│         Status: "InProgress"         │
│         المدة: 3 أشهر                │
└──────────┬───────────────────────────┘
           │
           │ [متابعة دورية]
           │
           ├─────────────┬─────────────┐
           │             │             │
           ▼             ▼             ▼
       [تحسن جيد]   [تحسن بطيء]   [لا تحسن]
           │             │             │
           ▼             ▼             ▼
      "Completed"   "Extended"     "Failed"
           │         (+1 شهر)          │
           │             │             │
           └─────────────┴─────────────┘
                         │
                         ▼
                 [قرار إداري]
```

---

## 9. اعتماد التقييم من HR

### المسار (Flow)
```
┌──────────────┐
│   موظف HR    │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. يستلم إشعار              │
│    "تقييم جديد بحاجة        │
│     للاعتماد"               │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. الانتقال إلى            │
│    /hr/evaluations-approval │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. عرض قائمة التقييمات     │
│    Filter: Status =         │
│            "Finalized"      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 4. مراجعة التقييم                 │
│    عرض:                            │
│    ├─ معلومات الموظف              │
│    ├─ معلومات المدير              │
│    ├─ جميع الدرجات                │
│    │  ├─ GoalsScore              │
│    │  ├─ BehaviorScore           │
│    │  └─ InitiativesScore        │
│    ├─ TrainingImpact             │
│    ├─ FinalScore                 │
│    ├─ FinalRating                │
│    ├─ ملاحظات المدير             │
│    └─ معادلة الحساب               │
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. التحقق من الصحة          │
│    ✓ جميع الدرجات صحيحة    │
│    ✓ الحساب صحيح            │
│    ✓ التصنيف مناسب          │
│    ✓ لا تحيز ظاهر           │
└──────┬──────────────────────┘
       │
       ├───────────────┬───────────────┐
       │               │               │
       ▼               ▼               ▼
   [اعتماد]       [طلب تعديل]     [رفض]
       │               │               │
       ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│POST          │ │إشعار للمدير │ │POST          │
│/api/         │ │بالتعديلات   │ │/api/         │
│evaluations/  │ │المطلوبة     │ │evaluations/  │
│{id}/approve  │ │              │ │{id}/reject   │
│              │ │Status =      │ │              │
│Body: {       │ │"InProgress"  │ │Body: {       │
│ approved:    │ │              │ │ reason: "..." │
│  true,       │ │              │ │}             │
│ hrNotes: "..." │ │              │ └──────┬───────┘
│}             │ │              │        │
└──────┬───────┘ └──────────────┘        │
       │                                 │
       ▼                                 ▼
┌──────────────────┐            ┌─────────────────┐
│Backend:          │            │Backend:         │
│Status =          │            │Status =         │
│ "Approved"       │            │ "Rejected"      │
│ApprovedAt = Now  │            │                 │
│ApprovedBy = HRId │            │إشعار للمدير    │
└──────┬───────────┘            │للمراجعة        │
       │                        └─────────────────┘
       ▼
┌─────────────────────────────┐
│ 6. نشر التقييم للموظف      │
│    - الموظف يستطيع الآن    │
│      مشاهدة تقييمه         │
│    - إرسال إشعار للموظف:   │
│      "تقييمك الجديد متاح"  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. إضافة لسجل الموظف       │
│    - حفظ في Performance     │
│      History                │
│    - تحديث Average Rating   │
│    - تحديث Dashboard Stats  │
└──────────────────────────────┘
```

### مستويات الموافقة
```
Manager       HR         Employee
   │           │            │
   ▼           │            │
[إنشاء]       │            │
   │           │            │
   ▼           │            │
[إدخال        │            │
 الدرجات]     │            │
   │           │            │
   ▼           │            │
[إنهاء]       │            │
Status:        │            │
"Finalized"    │            │
   │           │            │
   │           ▼            │
   │       [مراجعة]        │
   │           │            │
   │           ▼            │
   │       [اعتماد]        │
   │       Status:          │
   │       "Approved"       │
   │           │            │
   │           │            ▼
   │           │        [عرض
   │           │         النتيجة]
   └───────────┴────────────┘
```

---

## 10. إدارة خطط التحسين (PIPs)

### المسار (Flow)
```
┌──────────────┐
│   موظف HR    │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. الانتقال إلى            │
│    /hr/pips-management      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. عرض قائمة PIPs           │
│    الفلاتر:                 │
│    ├─ حسب الموظف           │
│    ├─ حسب القسم            │
│    ├─ حسب الحالة           │
│    └─ حسب تاريخ البدء      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 3. اختيار PIP للمتابعة            │
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 4. عرض تفاصيل PIP                 │
│    ├─ معلومات الموظف              │
│    ├─ التقييم المرتبط             │
│    ├─ تاريخ البدء والانتهاء       │
│    ├─ الأهداف التحسينية           │
│    ├─ تقدم كل هدف                 │
│    ├─ الاجتماعات المجدولة          │
│    └─ التقارير الدورية            │
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. المتابعة الدورية        │
│    كل أسبوعين:             │
│    ├─ اجتماع مع الموظف     │
│    ├─ مراجعة التقدم        │
│    ├─ تحديث الملاحظات      │
│    └─ توثيق الاجتماع       │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. بعد 3 أشهر: التقييم النهائي│
└──────┬──────────────────────┘
       │
       ├─────────────┬─────────────┬──────────────┐
       │             │             │              │
       ▼             ▼             ▼              ▼
  [تحسن كبير]  [تحسن جزئي]  [تحسن طفيف]  [لا تحسن]
       │             │             │              │
       ▼             ▼             ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│Status:       │ │Status:       │ │Status:       │ │Status:       │
│"Completed"   │ │"Extended"    │ │"Extended"    │ │"Failed"      │
│              │ │المدة: +1 شهر│ │المدة: +2 شهر│ │              │
│- عودة للعمل │ │              │ │              │ │- تحويل لـ   │
│  الطبيعي    │ │- مواصلة     │ │- خطة أكثر   │ │  الإدارة    │
│- مكافأة     │ │  الجهود     │ │  تركيزاً   │ │- قرار بشأن  │
│  (اختياري)  │ │              │ │              │ │  الاستمرار  │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

### أهداف PIP النموذجية
```
الهدف 1: تحسين معدل إنجاز المهام
├─ القيمة المستهدفة: 85% من المهام في الوقت المحدد
├─ المدة: 3 أشهر
├─ الدعم: تدريب على إدارة الوقت
└─ القياس: تقرير أسبوعي

الهدف 2: تطوير المهارات الفنية
├─ القيمة المستهدفة: إكمال 3 دورات تدريبية
├─ المدة: 3 أشهر
├─ الدعم: ميزانية للدورات
└─ القياس: الشهادات + تقييم المدير

الهدف 3: تحسين التواصل مع الفريق
├─ القيمة المستهدفة: تقييم إيجابي من الزملاء
├─ المدة: 3 أشهر
├─ الدعم: جلسات Coaching
└─ القياس: استبيان 360 درجة
```

---

## 11. إدارة التدريبات

### المسار (Flow)
```
┌──────────────┐
│   موظف HR    │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. الانتقال إلى            │
│    /hr/trainings-management │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 2. إنشاء تدريب جديد         │
│    الضغط على "إضافة تدريب" │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 3. فتح CreateTrainingDialog        │
│    الحقول:                         │
│    ├─ عنوان التدريب *             │
│    ├─ الوصف                        │
│    ├─ نوع التدريب                 │
│    │  ├─ فني (Technical)           │
│    │  ├─ قيادي (Leadership)        │
│    │  ├─ سلوكي (Behavioral)        │
│    │  └─ آخر (Other)               │
│    ├─ المدرب                       │
│    ├─ الموقع / الرابط              │
│    ├─ تاريخ البدء *                │
│    ├─ تاريخ الانتهاء *             │
│    ├─ المدة (ساعات)               │
│    └─ الحد الأقصى للمشاركين       │
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. حفظ التدريب              │
│    POST /api/trainings      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. تعيين الموظفين للتدريب  │
│    - اختيار الموظفين        │
│    - أو فتح التسجيل للجميع  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. إرسال دعوات              │
│    - إشعار داخلي            │
│    - Email                  │
│    - رابط التسجيل           │
└──────┬──────────────────────┘
       │
       ▼
┌──────────────────────────────────┐
│ 7. تتبع الحضور                 │
│    أثناء/بعد التدريب:          │
│    ├─ تسجيل الحضور            │
│    ├─ تسجيل نسبة الحضور       │
│    └─ تقييم التدريب من المشاركين│
└──────┬─────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 8. إصدار الشهادات           │
│    للحاضرين بنسبة > 80%    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 9. تحديث سجل الموظف         │
│    - إضافة للـ Training     │
│      Records                │
│    - حساب Training Impact   │
│      للتقييمات القادمة     │
└──────────────────────────────┘
```

### حساب أثر التدريب
```
┌─────────────────────────────┐
│ Training Records للموظف    │
│ خلال الفترة التقييمية      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ حساب معدل الحضور:          │
│                             │
│ معدل = (مجموع ساعات الحضور)│
│        ÷                    │
│        (مجموع ساعات التدريب)│
│        × 100                │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ تطبيق على التقييم:         │
│                             │
│ If معدل ≥ 85%:             │
│    TrainingImpact = +0.15   │
│    (مكافأة للالتزام)       │
│                             │
│ Else If معدل < 60%:        │
│    TrainingImpact = -0.20   │
│    (عقوبة لعدم الالتزام)   │
│                             │
│ Else:                       │
│    TrainingImpact = 0.00    │
│    (محايد)                  │
└──────────────────────────────┘
```

---

## 12. توليد التقارير

### المسار (Flow)
```
┌──────────────┐
│  أي مستخدم   │
│ حسب الصلاحيات│
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. الانتقال إلى صفحة التقارير│
│    - HR: /hr/reports        │
│    - Manager: /manager/     │
│               reports       │
│    - Executive: /executive/ │
│                reports      │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 2. اختيار نوع التقرير             │
│    A) تقرير أداء الموظف           │
│    B) تقرير أداء الفريق/القسم    │
│    C) تقرير PIPs                   │
│    D) تقرير التدريبات              │
│    E) تقرير الأهداف                │
│    F) تقرير شامل                   │
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. اختيار المعايير          │
│    ├─ الفترة (من - إلى)    │
│    ├─ الموظف/القسم         │
│    ├─ نوع البيانات المطلوبة│
│    └─ التنسيق (PDF/Excel)  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 4. Backend: جمع البيانات    │
│    - استعلامات SQL معقدة   │
│    - حسابات إحصائية        │
│    - تنسيق البيانات        │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 5. توليد التقرير            │
│    If PDF:                  │
│      - استخدام iTextSharp  │
│      - تنسيق احترافي        │
│      - شعار الجهة           │
│    If Excel:                │
│      - استخدام EPPlus      │
│      - جداول منسقة          │
│      - رسوم بيانية          │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 6. عرض/تحميل التقرير       │
│    - معاينة في المتصفح     │
│    - زر التحميل             │
│    - حفظ نسخة في النظام    │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 7. تسجيل في Audit Log       │
│    - من أنشأ التقرير؟      │
│    - ما نوع التقرير؟       │
│    - متى تم إنشاؤه؟        │
│    - البيانات المضمنة؟     │
└──────────────────────────────┘
```

### أنواع التقارير التفصيلية

#### A) تقرير أداء الموظف
```
┌─────────────────────────────────────┐
│ تقرير أداء الموظف - 2024         │
├─────────────────────────────────────┤
│ معلومات الموظف                    │
│ ├─ الاسم:                          │
│ ├─ القسم:                          │
│ ├─ الوظيفة:                        │
│ └─ المدير المباشر:                │
├─────────────────────────────────────┤
│ ملخص الأداء                        │
│ ├─ متوسط التقييم: 4.2             │
│ ├─ التصنيف: يفوق التوقعات         │
│ ├─ عدد الأهداف: 8                 │
│ ├─ الأهداف المكتملة: 7 (87.5%)   │
│ └─ معدل التدريب: 90%              │
├─────────────────────────────────────┤
│ تفصيل التقييمات                   │
│ Q1 2024: 4.1 - يفوق التوقعات      │
│ Q2 2024: 4.3 - متميز               │
│ Q3 2024: 4.2 - يفوق التوقعات      │
│ Q4 2024: 4.2 - يفوق التوقعات      │
├─────────────────────────────────────┤
│ تفصيل الأهداف                     │
│ [جدول بكل الأهداف والتقدم]        │
├─────────────────────────────────────┤
│ التدريبات المكتملة                │
│ [قائمة التدريبات مع الشهادات]     │
├─────────────────────────────────────┤
│ التوصيات                           │
│ [توصيات للتطوير المستقبلي]        │
└─────────────────────────────────────┘
```

#### B) تقرير أداء القسم
```
┌─────────────────────────────────────┐
│ تقرير أداء القسم - IT 2024       │
├─────────────────────────────────────┤
│ إحصائيات عامة                     │
│ ├─ عدد الموظفين: 25               │
│ ├─ متوسط الأداء: 3.8              │
│ ├─ معدل إكمال الأهداف: 82%       │
│ └─ معدل التدريب: 78%              │
├─────────────────────────────────────┤
│ توزيع التصنيفات                   │
│ ├─ متميز: 6 (24%)                 │
│ ├─ يفوق التوقعات: 10 (40%)       │
│ ├─ يلبي التوقعات: 7 (28%)        │
│ ├─ يحتاج تحسين: 2 (8%)            │
│ └─ غير مرضي: 0 (0%)               │
├─────────────────────────────────────┤
│ PIPs النشطة                        │
│ ├─ العدد: 2                        │
│ └─ [تفاصيل كل PIP]                │
├─────────────────────────────────────┤
│ الاتجاهات (Trends)                │
│ [رسم بياني للأداء عبر الأرباع]   │
├─────────────────────────────────────┤
│ أفضل الموظفين أداءً               │
│ [قائمة Top 5]                      │
├─────────────────────────────────────┤
│ التوصيات للإدارة                  │
│ [نقاط القوة والضعف والفرص]        │
└─────────────────────────────────────┘
```

---

## 13. نظام الإشعارات

### المسار (Flow)
```
┌─────────────────────────────┐
│ حدث في النظام (Event)      │
│ مثال: إنشاء هدف جديد       │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 1. Trigger Notification     │
│    Service                  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 2. تحديد المستلمين               │
│    على حسب نوع الحدث:            │
│    ├─ هدف جديد → المدير          │
│    ├─ موافقة هدف → الموظف       │
│    ├─ تقييم جديد → الموظف، HR   │
│    └─ PIP جديد → الموظف، المدير، HR│
└──────┬────────────────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 3. إنشاء Notification       │
│    Entity                   │
│    ├─ UserId (المستلم)     │
│    ├─ Type                  │
│    ├─ Title                 │
│    ├─ Message               │
│    ├─ Link                  │
│    ├─ IsRead = false        │
│    └─ CreatedAt = Now       │
└──────┬──────────────────────┘
       │
       ├──────────────┬──────────────┐
       │              │              │
       ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 4a. In-App   │ │ 4b. Email    │ │ 4c. SignalR  │
│ Notification │ │ Notification │ │ (Real-time)  │
│              │ │              │ │              │
│- حفظ في DB  │ │- SMTP Send   │ │- Push to     │
│- عرض في Bell│ │- Template    │ │  Connected   │
│  Icon        │ │- Formatting  │ │  Clients     │
└──────────────┘ └──────────────┘ └──────────────┘
       │              │              │
       └──────────────┴──────────────┘
                      │
                      ▼
┌─────────────────────────────┐
│ 5. Frontend: عرض الإشعار    │
│    ├─ Bell Icon بعداد      │
│    ├─ Notification Panel    │
│    ├─ صوت (اختياري)        │
│    └─ Desktop Notification  │
│       (إذا مفعل)            │
└──────────────────────────────┘
```

### أنواع الإشعارات
```
┌─────────────────────────────────────────────┐
│ نوع الإشعار         │ المرسل إليه          │
├─────────────────────┼───────────────────────┤
│ NewGoalCreated      │ Manager               │
│ GoalApproved        │ Employee              │
│ GoalRejected        │ Employee              │
│ GoalProgressUpdated │ Manager               │
│ GoalCompleted       │ Manager               │
│ EvaluationCreated   │ Employee              │
│ EvaluationFinalized │ HR                    │
│ EvaluationApproved  │ Employee              │
│ PIPCreated          │ Employee, Manager, HR │
│ PIPUpdated          │ Employee, Manager, HR │
│ PIPCompleted        │ Employee, Manager, HR │
│ TrainingAssigned    │ Employee              │
│ TrainingReminder    │ Employee              │
│ ReportGenerated     │ Requester             │
└─────────────────────────────────────────────┘
```

### SignalR Hub للإشعارات الفورية
```
Backend                     Frontend
   │                           │
   │ [حدث جديد]               │
   │                           │
   ├─► NotificationHub         │
   │   SendNotification()      │
   │                           │
   │   ────────────────────────┼─►
   │                           │
   │                           │ [استقبال]
   │                           │
   │                           ├─► عرض Toast
   │                           │   Notification
   │                           │
   │                           ├─► تحديث Bell
   │                           │   Counter
   │                           │
   │                           └─► تحديث
   │                               Notification
   │                               Panel
```

---

## 📊 ملخص حالات الكيانات (Entities States)

### Goal States
```
Draft ────► Approved ────► InProgress ────► Completed
  │                                             ▲
  └────────────► Cancelled                      │
                                                │
                                    [Progress = 100%]
```

### Evaluation States
```
Draft ────► InProgress ────► Finalized ────► Approved
                                │
                                └──► [Score < 2.5]
                                         │
                                         ▼
                                   Auto Create PIP
```

### PIP States
```
Draft ────► InProgress ────┬────► Completed
                           │
                           ├────► Extended
                           │
                           └────► Failed
```

### Training Attendance
```
Registered ────► Attended ────► Completed ────► Certified
     │                                              ▲
     └────────────► Absent                          │
                                         [Attendance > 80%]
```

---

## 📝 ملاحظات مهمة للمطورين

### 1. المصادقة والتفويض
- جميع API Endpoints محمية بـ JWT
- التحقق من الأدوار في كل طلب
- تسجيل جميع العمليات الحساسة في Audit Log

### 2. معالجة الأخطاء
- استخدام try-catch في جميع العمليات
- رسائل خطأ واضحة ومترجمة
- عدم كشف معلومات حساسة في الأخطاء

### 3. الأداء
- استخدام Pagination للقوائم الطويلة
- Caching للبيانات التي لا تتغير كثيراً
- Lazy Loading للبيانات الكبيرة

### 4. الأمان
- Input Validation على Frontend و Backend
- تشفير البيانات الحساسة
- Rate Limiting للـ APIs
- CORS محدد للنطاقات المعتمدة

### 5. الإشعارات
- Async processing لعدم تأخير Response
- Queue system للإشعارات الكثيرة
- Retry mechanism في حال فشل الإرسال

---

**آخر تحديث**: 2024-11-05
**الحالة**: موثق بالكامل
